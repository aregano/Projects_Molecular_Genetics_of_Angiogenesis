---
title: "Liver_2weeks_Overview_v2"
author: "Alvaro Regano"
date: "29/11/2021"
output:
  BiocStyle::html_document:
    toc: true
    toc_float: true
---

```{r setup, include=FALSE}
library(knitr)

knitr::opts_chunk$set(
  echo = TRUE, out.width = "200%", fig.align = "center",fig.width = 16,fig.height = 7,
  message = FALSE, warning = FALSE
)
#knitr::opts_knit$set(root.dir= normalizePath('..'))
#knitr::opts_chunk$set(error = FALSE)
options(width = 9000)

```

```{r library, echo=FALSE}
library(Seurat)
library(ggplot2)
library("knitr")
library("rmarkdown")
library("yaml")
library("patchwork")
```

# Liver 2 week deletion Overview

## Carlos Original UMAP and Clusters

I will make a quick overview of the quality of the integration of the Liver 2 week deletion plot. 
First I will plot the starting UMAP plot we got from Carlos of Liver 20Jan21

![Carlos_UMAP](../Plots/Rui_Comparisons/UMAP_Carlos_settings_res_0.35.png)

![Carlos_UMAP_New_Clustering](../Plots/Rui_Comparisons/UMAP_Carlos_NewClustering.png)

## Liver Integration 2 weeks. 7 dimensions

Lets quickly remind how it looked with 7 dims

```{r UMAPdim7, fig.asp=0.8, echo=FALSE}

Liver <- readRDS("../rds/Liver_2wdeletion.v3.ECs.rds")


p1 <- DimPlot(Liver, reduction = "umap.7dim", label = T, pt.size = 2, label.size = 12) + scale_x_reverse() + scale_y_reverse()
p1

p2 <- DimPlot(Liver, label = T, reduction = "umap.7dim", group.by = "NewClustering",pt.size = 2, label.size = 12) + scale_x_reverse() + scale_y_reverse()
p2

```



## Liver Integration 2 weeks. 6 dimensions. Reestructuring with min distance and n neighbors

I saw that with 6 dimensions I was able to keep the AV zonation, however the plot looked a bit messier

SO let's quickly look at it.

```{r UMAP6dim, fig.asp=0.8, echo=FALSE}

p1 <- DimPlot(Liver, reduction = "umap.6dim", label = T, pt.size = 2, label.size = 12)
p1

p2 <- DimPlot(Liver, reduction = "umap.6dim", label = T, group.by = "NewClustering",pt.size = 2, label.size = 12)
p2

```

So with 6 dimensions the AZ zonation is kept but cluster 4 looks a bit weird (ArterioVenous) and the cells look a bit over the place.

UMAPs have two key parameters, minimal distance and number of neighbors. Since we want to boost the global structure over the local y will do a run of different settings of these two parameters under 6 dimensions so I can get a more compacted, globally clear UMAP.

I will start with distances. I will go from 0-0.8, making a 0.1 increment for each iteration


```{r UMAP6dimdist, fig.height= 15, fig.width= 15, echo=FALSE}

dist <- c(0, 0.1, 0.2, 0.3, 0.4, 0.5, 0.6, 0.7, 0.8)
n <- as.data.frame(list(c(1:9)))


myplots <- vector('list', nrow(n))


for (i in 1:length(dist)){

  Liver <- RunUMAP(Liver, dims = 1:6, min.dist = dist[i], n.neighbors = 50)
  myplots[[i]] <- local({
    i <- i
    p1 <- DimPlot(Liver) + ggtitle(paste("Min Dist",dist[i]))+ theme(plot.title = element_text(hjust = 0.5))+ scale_y_reverse()
  })
  
}

p4 <- CombinePlots(plots = myplots, ncol = 3)
p4


```

It seems like 0.2 is the best distance. I will go onto calculating the best neighbor number.

I will go from 30 to 110 neighbors, increasing 10 by 10 in each iteration.


```{r UMAPdim6neighbors, fig.height= 15, fig.width= 15, echo=FALSE}

neigh <- c( 30, 40, 50, 60, 70, 80 , 90, 100, 110)

# neigh <- c(80 , 90, 100, 110, 120, 130, 140, 150,160)


for (i in 1:length(neigh)){
  
  Liver <- RunUMAP(Liver, dims = 1:6, min.dist = 0.2, n.neighbors = neigh[i])
  myplots[[i]] <- local({
    i <- i
    p1 <- DimPlot(Liver) + ggtitle(paste("Neighbor #",neigh[i]))+ theme(plot.title = element_text(hjust = 0.5))
  })
  
}

p4 <- CombinePlots(plots = myplots, ncol = 3)
p4

```


I conclude that the best settings to preserve the global structure Rui wants is setting up for a min.dist of 0.2 and n.neighbor of 100.

I will save this umap with the name: "umap_6d_0.2dist_100n"

```{r umap6d0.2dis100n, fig.asp=0.8 ,echo=FALSE}

p1 <- DimPlot(Liver, reduction = "umap_6d_0.2dist_100n", label = T, pt.size = 1.5, label.size = 10)
p1

p2 <- DimPlot(Liver, reduction = "umap_6d_0.2dist_100n", group.by = "NewClustering",label = T, pt.size = 1.5, label.size = 10)
p2

```

## Clustering like Carlos

After many different settings I have come up with this configuration for the final Clustering

```{r umapClustering, fig.asp=0.8 ,echo=FALSE}

Liver <- FindNeighbors(Liver, dims = 1:6, prune.SNN = 1/7, n.trees = 50, k.param = 50)

Liver <- FindClusters(Liver, resolution = 0.26)

p1 <- DimPlot(Liver, label = T, reduction = "umap_6d_0.2dist_100n", pt.size = 1.5, label.size = 8)

p1

```

# Conclusion

By tweaking the min distance values and n neighbors I have produced a plot that better preserves the global structure of the Liver 2 weeks scRNASeq sample. Next I will plot the general markers onto this final UMAP


```{r session, ,echo=FALSE}

sessionInfo()

```